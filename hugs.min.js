/* 
 * Simple JavaScript templating system.
 *   (c) 2010, Borgar Ãžorsteinsson
 * 
 * Licenced under the terms of the MIT software licence.
 *   http://www.opensource.org/licenses/mit-license.php
 * 
 */
(function(k){function j(a,b){for(var c=[],d=0,f=a.length;d<f;d++)c.push(b(a[d],d));return c}function l(a,b){for(var c in b)a[c]=b[c];return a}function i(a){a=Object.prototype.toString.call(a);return a.substring(8,a.length-1).toLowerCase()}function h(a){if(a in h.tmpl)return h.tmpl[a];if(this instanceof h)this.nodes=this.parse(a);else return new h(a)}var e=k.Template=h;e.prototype={render:function(a){if(i(a)==="array"){var b=this;return j(a,function(c){return b.nodes.toString(c)})}return this.nodes.toString(a||{})},parse:function(a,b){if(i(a)==="string"){var c=a.replace(/\{#("(\"|[^"])*?"|'(\'|[^'])*?'|[\S\s])*?#\}/g,"");for(a=[];c.length;){var d=c.match(/^([\S\s]*?)(\{\{("(\"|[^"])*?"|'(\'|[^'])*?'|.)*?\}\})/);if(d){d[1]&&a.push(d[1]);a.push(d[2]);c=c.substr(d[0].length)}else{a.push(c);c=""}}}for(c=[];a.length;){var f=a.shift();if((d=f.match(/^(\{[\{#])\s*((\=|\w+).*?)\s*[\}#]\}$/))&&d[1]==="{{"){f=d[3];var g=d[2].substr(d[3].length);if(b&&f in b){a.unshift(f);return new e.Nodelist(c)}if(e.tags[f]){d=new e.Node(f,g);d.resolve=this.compile_variable(g);if(!e.tags[f].single){f=this.parse(a,{"else":1,end:1});g=a.shift();if(g==="else"){d.$TRUE=f;f=this.parse(a,{end:1});g=a.shift()}if(g==="end")if(d.$TRUE!=="")d.$FALSE=f;else d.$TRUE=f;else throw new e.Error("Unexpected termination by "+g);}c.push(d)}else throw new e.Error("Unknown template tag "+f);}else c.push(f)}if(b){a=[];for(var m in b)a.push(m);throw new e.Error("Unmatched block tag, expected: "+a.join(" or "));}return new e.Nodelist(c)},compile_variable:function(a){var b=a.replace(/"(\"|[^"])*?"|'(\'|[^'])*?'|[!=]=+|[><]=/g,"");if(/(^\s*\.|\.\s*$|\+\+|\-\-|[gls]et|new|[{}=])/.test(b))throw new e.Error('Illegal template operator "'+RegExp.lastMatch+'" in '+a);else if(/(abstract|b(oolean|reak|yte)|c(a(se|tch)|har|lass|on(st|tinue))|d(e(bugger|fault|lete)|o(uble)?)|e(lse|num|x(port|tends))|f(inal(ly)?|loat|or|unction)|goto|i(mp(lements|ort)|n(stanceof|t(erface)?)|f)|long|n(ative|ew)|p(ackage|r(ivate|otected)|ublic)|return|s(hort|tatic|uper|witch|ynchronized)|t(hrows?|r(ansient|y))|v(ar|olatile)|w(hile|ith)|yeild)/.test(b))throw new e.Error('Illegal reserved word "'+RegExp.lastMatch+'" in '+a);return new Function("","try{with(this){with(Template.vars){with(Template.fn){return ["+a+"];}}}}catch(e){if(Template.SILENT && (e instanceof ReferenceError || e instanceof TypeError)){return [Template.INVALID];}throw e;}")}};l(e,{SILENT:true,INVALID:"",render:function(a,b){return(new e(a)).render(b||{})},tags:{"=":{handler:function(a){return a},single:true},"if":{handler:function(a){return(a?this.$TRUE:this.$FALSE)+""}},each:{handler:function(a){var b=this.$TRUE,c=e.vars;if(!a||!a.length||i(a)==="string")return this.$FALSE+"";var d=j(a,function(f,g){c.each={counter:g,first:g===0,last:g===a.length};return b.toString(f)});delete c.each;return d}},include:{handler:function(a){return a in e.tmpl?e.render(a,this):this.$FALSE+""},single:true}},fn:{upper:function(a){return(a+"").toUpperCase()},lower:function(a){return(a+"").toLowerCase()},escape:function(a){return(a+"").replace(/&/g,"&amp;").replace(/"/g,"&quo;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}},tmpl:{},vars:{},Error:function(a){this.message=a;this.name="TemplateError";this.toString=function(){return this.name+': "'+this.message+'"'}},Node:function(a,b){this.tag=a;this.args=b;this.$TRUE=this.$FALSE=""},Nodelist:function(a){this.length=0;Array.prototype.push.apply(this,a||[])}});e.Node.prototype={toString:function(a){if(!arguments.length)return"<Template Node>";a=a||{};var b=this.resolve.call(a);a.$TRUE=this.$TRUE;a.$FALSE=this.$FALSE;var c=e.tags[this.tag].handler;if(!c)throw new e.Error('The "'+this.tag+'" tag is missing a handler function');return b.length===1?c.call(a,b[0]):c.apply(a,b)}};e.Nodelist.prototype.toString=function(a){for(var b=[],c=0,d;c<this.length;c++){d=this[c].toString(a);if(d.join)b=b.concat(d);else b[b.length]=d}return b.join("")}})(window);