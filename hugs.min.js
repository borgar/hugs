/* 
 * Simple JavaScript templating system.
 *   (c) 2010, Borgar Ãžorsteinsson
 * 
 * Licenced under the terms of the MIT software licence.
 *   http://www.opensource.org/licenses/mit-license.php
 * 
 */
(function(){function i(a,b){for(var d=[],c=0,f=a.length;c<f;c++)d.push(b(a[c],c));return d}function j(a,b){for(var d in b)a[d]=b[d];return a}function h(a){if(a in h.tmpl)return h.tmpl[a];if(this===window)return new h(a);this.nodes=this.parse(a)}var e=window.Template=h;e.prototype={render:function(a){if(Object.prototype.toString.call(a)==="[object Array]"){var b=this;return i(a,function(d){return b.nodes.toString(d)})}return this.nodes.toString(a||{})},parse:function(a,b){if(typeof a==="string")a= a.split(/(\{[\{#].*?[\}#]\})/g);for(var d=[];a.length;){var c=a.shift(),f=c.match(/(\{[\{#])\s*((\=|\w+).*?)\s*[\}#]\}/);if(f&&f[1]==="{{"){c=f[3];var g=f[2].substr(f[3].length);if(b&&c in b){a.unshift(c);return new e.Nodelist(d)}if(e.tags[c]){f=new e.Node(c,g);f.resolve=this.compile_variable(g);if(!e.tags[c].single){c=this.parse(a,{"else":1,end:1});g=a.shift();if(g==="else"){f.$TRUE=c;c=this.parse(a,{end:1});g=a.shift()}if(g==="end")if(f.$TRUE!=="")f.$FALSE=c;else f.$TRUE=c;else throw new e.Error("Unexpected termination by "+ g);}d.push(f)}else throw new e.Error("Unknown template tag "+c);}else f&&f[1]==="{#"||d.push(c)}if(b){a=[];for(var k in b)a.push(k);throw new e.Error("Unmatched block tag, expected: "+a.join(" or "));}return new e.Nodelist(d)},compile_variable:function(a){var b=a.replace(/"(\"|[^"])*"|'(\'|[^'])*'|[!=]=+|[><]=/g,"!!!");if(/(^\s*\.|\.\s*$|\+\+|\-\-|[gls]et|new|[{}=])/.test(b))throw new e.Error('Illegal template operator "'+RegExp.lastMatch+'" in '+a);else if(/(abstract|b(oolean|reak|yte)|c(a(se|tch)|har|lass|on(st|tinue))|d(e(bugger|fault|lete)|o(uble)?)|e(lse|num|x(port|tends))|f(inal(ly)?|loat|or|unction)|goto|i(mp(lements|ort)|n(stanceof|t(erface)?)|f)|long|n(ative|ew)|p(ackage|r(ivate|otected)|ublic)|return|s(hort|tatic|uper|witch|ynchronized)|t(hrows?|r(ansient|y))|v(ar|olatile)|w(hile|ith)|yeild)/.test(b))throw new e.Error('Illegal reserved word "'+ RegExp.lastMatch+'" in '+a);return new Function("","try{with(this){with(Template.vars){with(Template.fn){return ["+a+"];}}}}catch(e){if(Template.SILENT && e instanceof ReferenceError){return [Template.INVALID];}throw e;}")}};j(e,{SILENT:true,INVALID:"",render:function(a,b){return(new e(a)).render(b||{})},tags:{"=":{handler:function(a){return a},single:true},"if":{handler:function(a){return(a?this.$TRUE:this.$FALSE).toString(this)}},each:{handler:function(a){var b=this.$TRUE,d=e.vars;if(!a||!a.length|| typeof a==="string")return this.$FALSE.toString(this);var c=i(a,function(f,g){d.each={counter:g,first:g===0,last:g===a.length};return b.toString(f)});delete d.each;return c}},include:{handler:function(a){return a in e.tmpl?e.render(a,this):this.$FALSE.toString(this)},single:true}},fn:{upper:function(a){return(a+"").toUpperCase()},lower:function(a){return(a+"").toLowerCase()},escape:function(a){return(a+"").replace(/&/g,"&amp;").replace(/"/g,"&quo;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}},tmpl:{}, vars:{},Error:function(a){this.message=a;this.name="TemplateError";this.toString=function(){return this.name+': "'+this.message+'"'}},Node:function(a,b){this.tag=a;this.args=b;this.$TRUE=this.$FALSE=""},Nodelist:function(a){this.length=0;Array.prototype.push.apply(this,a||[])}});e.Node.prototype={toString:function(a){if(!arguments.length)return"<Template Node>";a=a||{};var b=this.resolve.call(a);a.$TRUE=this.$TRUE;a.$FALSE=this.$FALSE;var d=e.tags[this.tag].handler;if(!d)throw new e.Error('The "'+ this.tag+'" tag is missing a handler function');return b.length===1?d.call(a,b[0]):d.apply(a,b)}};e.Nodelist.prototype.toString=function(a){for(var b=[],d=0,c;d<this.length;d++){c=this[d].toString(a);if(c.join)b=b.concat(c);else b[b.length]=c}return b.join("")}})();